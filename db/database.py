import sqlite3
from config import DATABASE


def init_db():
    conn = sqlite3.connect(DATABASE)
    with open('db/schema.sql', 'r') as f:
        conn.executescript(f.read())
    conn.commit()
    conn.close()


def save_scan_results(url, results):
    conn = sqlite3.connect(DATABASE)
    cur = conn.cursor()

    cur.execute("INSERT INTO websites (url) VALUES (?)", (url,))
    website_id = cur.lastrowid

    for result in results:
        cur.execute("INSERT INTO scans (website_id, scan_time, duration) VALUES (?, datetime('now'), ?)",
                    (website_id, result['duration']))
        scan_id = cur.lastrowid

        for vulnerability in result['vulnerabilities']:
            cur.execute("INSERT INTO vulnerabilities (scan_id, type, severity, description) VALUES (?, ?, ?, ?)",
                        (scan_id, vulnerability['type'], vulnerability['severity'], vulnerability['description']))

    conn.commit()
    conn.close()
